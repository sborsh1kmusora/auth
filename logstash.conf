input {
  beats {
    port => 5044
  }
}

filter {
  # 1. Разбираем JSON Docker лога (от filebeat)
  json {
    source => "message"
    target => "docker"
    tag_on_failure => ["_docker_jsonparsefailure"]
  }

  # 2. Разбираем JSON из поля 'log' (zap логи)
  if [docker][log] {
    json {
      source => "[docker][log]"
      target => "parsed"
      tag_on_failure => ["_zap_jsonparsefailure"]
    }
  }

  # 3. Настраиваем @timestamp
  if [parsed][timestamp] {
    date {
      match => [ "[parsed][timestamp]", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # 4. Переносим важные поля
  if [parsed][msg] {
    mutate { rename => { "[parsed][msg]" => "message" } }
  }

  if [parsed][level] {
    mutate { rename => { "[parsed][level]" => "log.level" } }
  }

  # 5. Если filebeat уже переименовал 'msg' в 'message', можно добавить fallback
  if [parsed][message] {
    mutate { rename => { "[parsed][message]" => "message" } }
  }
}

output {
  elasticsearch {
    hosts => ["http://elastic:9200"]
    index => "auth-logs-%{+YYYY.MM.dd}"
  }

  stdout { codec => rubydebug }
}